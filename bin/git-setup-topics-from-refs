#! /bin/bash
SUBDIRECTORY_OK='Yes'
OPTIONS_KEEPDASHDASH=no
OPTIONS_SPEC="\
git setup-topics-from-refs PREFIX

Make local working branches (tracking master locally) for every ref
that starts with the given prefix. Useful for getting working branches
back from gerrit user refs:

  git setup-topics-from-refs refs/remotes/gerrit/u/\$(whoami)/

--
"

. git-sh-setup

set -ueo pipefail

# $1 == --
[[ $# == 2 ]] || usage
PREFIX="${2%/}"/
git for-each-ref --format='%(objectname) %(refname)' "$PREFIX" |
while read SHA REF
do
    LOCAL=${REF#$PREFIX}
    git branch --quiet --track $LOCAL master >/dev/null 2>&1 || continue
    echo Added $LOCAL >&2
    git config branch.$LOCAL.rebase true
    git push -q . +$REF:refs/heads/$LOCAL
done
