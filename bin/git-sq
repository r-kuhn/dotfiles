#! /bin/bash
set -e

SUBDIRECTORY_OK='Yes'
OPTIONS_KEEPDASHDASH=
OPTIONS_SPEC="\
git sq [options] [--] [paths...]

Squash (git commit --amend --no-edit) the current staged content into
the HEAD commit, as long as its not on the upstream branch.

--
q,quiet    Supress the checkout and pull messages.
a,all      Commit all changes, unstaged changes included.
"

. git-sh-setup

declare -a flags
while test $# != 0 ; do
    case "$1" in
        -q|--quiet)
            GIT_QUIET="$1"
            flags+=("$1")
            ;;
        -a|--all)
            flags+=("$1")
            ;;
        --)
            shift
            break
            ;;
    esac
    shift
done
flags+=( -- "$@" )

ok_to_amend() {
    # Get the current branch (full ref name)
    head=$(git rev-parse --symbolic-full-name HEAD)
    [[ -n $head ]] || return 0

    # Get the upstream and shorten the HEAD rev
    eval $(git for-each-ref --format='
upstream=%(upstream:short)
head=%(refname:short)
' "$head")
    [[ -n $upstream ]] || return 0

    [[ -n $(git rev-list "$upstream..$head") ]]
}

if ok_to_amend ; then
    git commit --amend --no-edit "${flags[@]}"
else
    die "amend aborted: HEAD is included in $upstream (upstream of $head)."
fi
