#! /bin/bash
SUBDIRECTORY_OK='Yes'
OPTIONS_KEEPDASHDASH=
OPTIONS_SPEC="\
git pull-all [--no-fetch]

Fast-forward all local tracking branches to the tip of their upstream branches.
--
no-fetch       Do not fetch from the remotes before fast-forwarding the local branches.
"

. git-sh-setup

fetch=1
while test $# != 0
do
    case "$1" in
        --no-fetch)
            fetch=0
            ;;
        --)
            shift
            break
            ;;
    esac
    shift
done
test $# != 0 && usage

declare -r current_branch=$(git symbolic-ref HEAD 2>/dev/null)
declare -a refspec=($(
        git for-each-ref --format='%(upstream):%(refname)' refs/heads |
        grep '^refs/remotes/'))
[[ ${#refspec[*]} == 0 ]] && die "No branches to update"

restore_current_branch=0
if test -n "$current_branch" && expr "${refspec[*]} " : ".*:$current_branch " >/dev/null
then
    require_clean_work_tree "fast-forward current branch"
    git checkout --detach --quiet
    restore_current_branch=1
fi

if test "$fetch" != 0
then
    git fetch --all
fi
git push . "${refspec[@]}"

if test $restore_current_branch != 0
then
    git checkout --quiet "${current_branch#refs/heads/}"
fi
